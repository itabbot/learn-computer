# 持续集成、持续交付、持续部署<!-- omit in toc -->

- [1. 综述](#1-综述)
- [2. 普遍原则](#2-普遍原则)
- [3. 典型流程](#3-典型流程)
- [4. 优缺点](#4-优缺点)
- [5. 常用工具](#5-常用工具)

## 1. 综述

**持续集成**：在传统的软件开发中，集成过程通常发生在项目结束时每个人都完成了他们的工作之后。整合通常需要较长（数周甚至数月）时间，而且可能会非常痛苦。持续集成（英文全称 Continuous Integration，缩写为 CI），是一种将集成阶段置于开发周期早期的实践，即团队开发成员经常集成他们的工作，每次集成都通过自动化（包括自动化编译、自动化测试等）来验证，从而尽早地发现集成错误。本阶段的测试主要是静态测试以及开发人员对自身变更代码的测试（比如单元测试），以确保其按预期工作。

<img src="./imgs/持续集成.png" width="700" alt="持续集成"/>

**持续交付**：经过持续集成，开发成员的更改虽然已成功集成在一起，并且代码按测试预期的那样工作，但它尚未准备好用于生产。持续交付（英文全称 Continuous delivery，缩写为 CD），旨在于确保软件可以稳定、持续的保持在随时可以发布的状态，意味着还需要在与生产环境非常相似的环境中自动测试此代码。一旦在所有环境中（通常有开发环境、测试环境和预发布环境，但因团队、产品和组织而异）通过测试，新的、经过全面测试的、可工作的软件就可以立即交付给客户。

<img src="./imgs/持续交付.png" width="700" alt="持续交付"/>

**持续部署**：持续交付意味着所有的变更都可以被部署到生产环境中，但是出于业务考虑，可以选择不部署。持续部署（英文全称 Continuous deployment，也缩写为 CD），意味着所有的变更都会被**自动**部署到生产环境中。

<img src="./imgs/持续部署.png" width="700" alt="持续部署"/>

## 2. 普遍原则

- 统一的代码库
- 开发人员每天都要向代码库主干提交代码
- 开发人员提交代码前需进行自测
- 每次提交代码后都会在持续集成服务器上触发一次构建
- 自动化构建
- 自动化测试
- 保证快速构建和测试
- 模拟生产环境进行测试
- 自动化部署

## 3. 典型流程

- 开发人员进行编码并自测，然后提交代码
- 持续集成服务器从版本控制服务器下载最新的代码
- 进行自动化编译
- 进行自动化测试验证集成，主要是静态测试以及开发人员对自身变更代码的测试
- 打包镜像并上传到镜像仓库中
- 在开发、测试或预发布等环境下拉镜像并启动容器
- 进行自动化测试进行全面验证
- 在生产环境下拉镜像并执行部署
- 上述各步骤均可按需发送结果反馈给团队成员

## 4. 优缺点

优点：

- 尽早发现集成错误：避免了发布上线前一分钟发生混乱。
- 低代价回滚：当测试失败或发生错误，若开发人员需要在不调试的情况下还原代码库到一个没有问题的状态，只需要放弃一小部分的更改（因为集成的次数频繁）。
- 发布过程变得更加可靠：部署过程和脚本在部署到生产环境之前会被反复测试，因此，部署过程和脚本中的大多数错误已经被发现。
- 问题更易于追踪：随着更频繁的发布，每个版本中的代码更改数量会减少。这使得查找和解决确实发生的任何问题变得更加容易，从而减少了它们产生影响的时间。
- 提高生产力和效率：通过自动化为开发人员、测试人员、运营工程师等节省大量时间。
- 防止功能分歧和大量冲突：帮助团队成员之间的协作，以便始终共享最近的代码，防止不同分支出现分歧。
- 测试纪律：强制执行频繁的自动化测试纪律。
- 促进团队成长：自动化测试和持续性集成产生的软件度量（如代码覆盖度量，代码复杂度和功能完整性等）标准将开发人员集中在开发功能性、高质量的代码上，并帮助开发团队发展。
- 加快上市时间：使组织能够更快地向客户交付新软件版本中固有的商业价值，这种能力帮助公司在竞争中领先一步。
- 构建合适的产品：频繁发布让应用程序开发团队更快地获得用户反馈，这让他们只处理有用的功能，如果他们发现某项功能没有用，他们就不会花更多的精力在它上面，这有助于他们构建正确的产品。
- 提高产品质量：公开错误和生产事件的数量显着减少。
- 提高客户满意度：实现更高水平的客户满意度。

缺点：

- 需要一定的成本：构建自动化测试需要大量的工作，包括不断努力以覆盖新功能，并依照特定情境进行代码修改。
- 人工测试限制：并非所有质量属性都可以通过自动化进行验证。这些属性需要循环中的人员，从而减慢了交付管道。
- 强依赖限制：一些功能必须等到完整开发完成后才能进行集成，在此之前的每次提交和合并都会构建失败。
- 客户偏好限制：一些客户不希望持续更新他们的系统，在他们运营的关键阶段尤其如此。
- 领域限制：在某些领域，例如电信和医疗，法规要求在允许新版本进入运营阶段之前进行大量测试。
- 环境差异问题：开发、测试和生产中使用的不同环境可能会导致未检测到的问题转移到生产环境中。

## 5. 常用工具

- [Jenkins](https://www.jenkins.io/zh/)
- [TravisCI](https://www.travis-ci.com/)
- [GoCD](https://www.gocd.org/)
- [Coding](https://coding.net/)
- Bamboo
- CircleCI
- TeamCity
