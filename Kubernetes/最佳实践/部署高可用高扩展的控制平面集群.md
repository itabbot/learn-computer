# 部署高可用高扩展的控制平面集群<!-- omit in toc -->

部署高可用高扩展的控制平面集群，有如下两个方案，在部署前，你应该仔细考虑每种方案的优缺点。

- [使用堆叠（stacked）控制平面节点](#1-堆叠stackedetcd-拓扑)，其中 etcd 节点与控制平面节点共存。
- [使用外部 etcd 节点](#2-外部-etcd-拓扑)，其中 etcd 在与控制平面不同的节点上运行。

## 1. 堆叠（Stacked）etcd 拓扑

在堆叠（Stacked）式集群中，每个控制平面节点运行 kube-apiserver、kube-scheduler、kube-controller-manager 和 etcd。kube-apiserver 使用负载均衡器暴露给工作节点。kube-scheduler、kube-controller-manager 和 etcd 只与该节点的 kube-apiserver 通信。

这种拓扑将控制平面和 etcd 成员耦合在同一节点上。相对使用外部 etcd 集群，设置起来更简单，而且更易于副本管理。然而，堆叠集群存在耦合失败的风险。如果一个节点发生故障，则 etcd 成员和控制平面实例都将丢失，并且冗余会受到影响。你可以通过添加更多控制平面节点来降低此风险。因此，你应该为控制平面集群运行至少三个堆叠的控制平面节点。

<img src="../imgs/高可用高扩展控制平面集群-堆叠etcd拓扑.svg" width="800" alt="高可用高扩展控制平面集群-堆叠etcd拓扑"/>

## 2. 外部 etcd 拓扑

就像堆叠的 etcd 拓扑一样，外部 etcd 拓扑中的每个控制平面节点都会运行 kube-apiserver、kube-scheduler 和 kube-controller-manager 实例。同样，kube-apiserver 使用负载均衡器暴露给工作节点。但是 etcd 分布式数据存储集群在独立于控制平面节点的其他节点上运行，每个 etcd 主机与每个控制平面节点的 kube-apiserver 通信。

这种拓扑结构解耦了控制平面和 etcd 成员。因此若其中失去控制平面实例或者 etcd 成员的影响较小，并且不会像堆叠的拓扑那样影响集群冗余。但此拓扑需要两倍于堆叠拓扑的主机数量。具有此拓扑的集群至少需要三个用于控制平面节点的主机和三个用于 etcd 节点的主机。

<img src="../imgs/高可用高扩展控制平面集群-外部etcd拓扑.svg" width="800" alt="高可用高扩展控制平面集群-外部etcd拓扑"/>
